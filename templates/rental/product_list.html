{% extends 'base.html' %}
{% load rental_filters %}

{% block title %}Каталог товаров - Аренда оборудования{% endblock %}

{% block content %}
<!-- Фильтры и поиск -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-dark">
                            <i class="fas fa-search text-primary"></i> Поиск товаров
                        </label>
                        <input type="text" name="search" class="form-control form-control-lg" 
                               placeholder="Введите название товара, артикул или описание..." 
                               value="{{ search_query }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-search"></i> Найти товары
                        </button>
                    </div>
                </form>
                
                <!-- Теги-фильтры -->
                <div class="mt-4">
                    <label class="form-label fw-bold text-dark mb-3">
                        <i class="fas fa-tags text-primary"></i> Категории
                    </label>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="?days={{ request.GET.days|default:1 }}" 
                           class="btn btn-outline-primary {% if not selected_tag %}btn-primary text-white{% endif %} rounded-pill">
                            <i class="fas fa-th-large"></i> Все товары
                        </a>
                        {% for tag in tags %}
                            <a href="?tag={{ tag.id }}&days={{ request.GET.days|default:1 }}" 
                               class="btn btn-outline-primary {% if selected_tag == tag.id|stringformat:'s' %}btn-primary text-white{% endif %} rounded-pill">
                                <i class="fas fa-tag"></i> {{ tag.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Результаты поиска -->
{% if search_query %}
<div class="alert alert-info border-0 shadow-sm">
    <i class="fas fa-info-circle"></i>
    Результаты поиска по запросу: <strong>"{{ search_query }}"</strong>
    <span class="badge bg-primary ms-2">{{ products.count }} товаров</span>
</div>
{% endif %}

<!-- Каталог товаров -->
<div class="row g-4">
    {% for product in products %}
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card product-card h-100 shadow-sm border-0 overflow-hidden">
            <!-- Изображение товара -->
            <div class="position-relative overflow-hidden">
                {% if product.photo %}
                    <img src="{{ product.photo.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                {% else %}
                    <div class="card-img-top product-image bg-gradient d-flex align-items-center justify-content-center">
                        <div class="text-center text-white">
                            <i class="fas fa-camera fa-3x mb-2 opacity-50"></i>
                            <p class="mb-0 small">Фото скоро появится</p>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Статус наличия -->
                <div class="position-absolute top-0 end-0 m-2">
                    {% if product.available_quantity <= 0 %}
                        <span class="badge bg-danger fs-6">Нет в наличии</span>
                    {% elif product.available_quantity <= 3 %}
                        <span class="badge bg-warning fs-6">Мало: {{ product.available_quantity }} шт.</span>
                    {% else %}
                        <span class="badge bg-success fs-6">{{ product.available_quantity }} шт.</span>
                    {% endif %}
                </div>
                
                <!-- Быстрый просмотр -->
                <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-2 product-overlay">
                    <small><i class="fas fa-barcode"></i> {{ product.article }}</small>
                </div>
            </div>
            
            <!-- Информация о товаре -->
            <div class="card-body d-flex flex-column">
                <h5 class="card-title fw-bold text-dark mb-2">{{ product.get_display_name }}</h5>
                
                {% if product.description %}
                    <p class="card-text text-muted small mb-3">{{ product.get_display_description|truncatewords:12 }}</p>
                {% endif %}
                
                <!-- Теги -->
                {% if product.tags.exists %}
                    <div class="mb-3">
                        {% for tag in product.tags.all|slice:":2" %}
                            <span class="badge bg-light text-dark me-1">{{ tag.get_display_name }}</span>
                        {% endfor %}
                        {% if product.tags.count > 2 %}
                            <span class="badge bg-light text-muted">+{{ product.tags.count|add:"-2" }}</span>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- Форма добавления в корзину -->
                <form method="post" action="{% url 'rental:add_to_cart' product.id %}" class="mt-auto">
                    {% csrf_token %}
                    
                    <!-- Калькулятор цены -->
                    <div class="bg-light rounded p-3 mb-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Количество:</label>
                                <input type="number" name="quantity" class="form-control form-control-sm" 
                                       value="1" min="1" max="{{ product.available_quantity }}" 
                                       id="qty-{{ product.id }}" onchange="updateProductPrice({{ product.id }}, {{ product.daily_price }})">
                            </div>
                         <!--   <div class="col-6">
                                <label class="form-label small fw-bold">Дней:</label>
                                <input type="number" name="days" class="form-control form-control-sm" 
                                       value="{{ request.GET.days|default:1 }}" min="1" max="365" 
                                       id="days-{{ product.id }}" onchange="updateProductPrice({{ product.id }}, {{ product.daily_price }})">
                            </div>-->
                        </div>
                        
                        <!-- Расчет стоимости -->
                        <div class="mt-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-success fs-5">{{ product.daily_price }} сум/день</span>
                            </div>
                         <!--   <small class="text-primary d-block mt-1" id="calc-{{ product.id }}">
                                {% with days=request.GET.days|default:1 %}
                                    {{ product.daily_price|floatformat:0 }} × 1 × {{ days }} = 
                                    <strong class="text-success">{{ product.daily_price|mul:days|floatformat:0 }} сум</strong>
                                {% endwith %}
                            </small>-->
                            
                            <!-- Информация о скидке -->
                            <div id="discount-{{ product.id }}" class="mt-1" style="display: none;">
                                <small class="text-success fw-bold">
                                    <i class="fas fa-percent"></i> <span class="discount-text"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Кнопки действий -->
                    <div class="d-grid gap-2">
                        {% if product.available_quantity > 0 %}
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-cart-plus"></i> Добавить в корзину
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-ban"></i> Нет в наличии
                            </button>
                        {% endif %}
                        
                        <a href="{% url 'rental:product_detail' product.id %}?days={{ request.GET.days|default:1 }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-info-circle"></i> Подробнее
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-search fa-5x text-muted opacity-50"></i>
            </div>
            <h3 class="text-muted">Товары не найдены</h3>
            <p class="text-muted">Попробуйте изменить параметры поиска или выберите другую категорию</p>
            <a href="{% url 'rental:product_list' %}" class="btn btn-primary">
                <i class="fas fa-refresh"></i> Показать все товары
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Уведомления -->
<div id="notifications" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

<style>
/* Дополнительные стили для каталога */
.product-card {
    transition: all 0.3s ease;
    border-radius: 15px !important;
}

.product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15) !important;
}

.product-image {
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}

.product-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.product-card:hover .product-overlay {
    opacity: 1;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.form-control:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.75em;
}

.card-title {
    font-size: 1.1rem;
    line-height: 1.3;
    min-height: 2.6rem;
}

.card-text {
    line-height: 1.4;
    min-height: 3rem;
}

/* Анимация для кнопок */
.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* Стили для уведомлений */
.notification {
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    border-left: 4px solid #28a745;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Адаптивность */
@media (max-width: 768px) {
    .product-card {
        margin-bottom: 1.5rem;
    }
    
    .card-title {
        font-size: 1rem;
        min-height: auto;
    }
    
    .card-text {
        min-height: auto;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Функция обновления цены товара
function updateProductPrice(productId, dailyPrice) {
    const quantityInput = document.getElementById('qty-' + productId);
    const daysInput = document.getElementById('days-' + productId);
    const calcDisplay = document.getElementById('calc-' + productId);
    const discountDiv = document.getElementById('discount-' + productId);
    
    const quantity = parseInt(quantityInput.value) || 1;
    const days = parseInt(daysInput.value) || 1;
    
    const baseTotal = dailyPrice * quantity * days;
    let finalTotal = baseTotal;
    let discount = 0;
    let discountText = '';
    
    // Рассчитываем скидку
    if (days >= 30) {
        discount = 15;
        discountText = 'Скидка 15% за аренду от 30 дней';
    } else if (days >= 14) {
        discount = 10;
        discountText = 'Скидка 10% за аренду от 14 дней';
    } else if (days >= 7) {
        discount = 5;
        discountText = 'Скидка 5% за аренду от 7 дней';
    }
    
    if (discount > 0) {
        finalTotal = baseTotal * (1 - discount / 100);
    }
    
    // Обновляем отображение цены
    calcDisplay.innerHTML = `
        ${dailyPrice} × ${quantity} × ${days} = 
        <strong class="text-success">${finalTotal.toFixed(0)} сум</strong>
        ${discount > 0 ? '<del class="text-muted ms-1">' + baseTotal.toFixed(0) + ' сум</del>' : ''}
    `;
    
    // Показываем информацию о скидке
    if (discount > 0) {
        discountDiv.querySelector('.discount-text').textContent = discountText + ` (экономия: ${(baseTotal - finalTotal).toFixed(0)} сум)`;
        discountDiv.style.display = 'block';
    } else {
        discountDiv.style.display = 'none';
    }
}

// AJAX добавление в корзину
document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем цены для всех товаров
    document.querySelectorAll('.card-body').forEach(function(cardBody) {
        const daysInput = cardBody.querySelector('input[name="days"]');
        if (daysInput) {
            const productId = daysInput.id.split('-')[1];
            const dailyPrice = parseFloat(cardBody.closest('.card').querySelector('.text-success').textContent.match(/[\d.]+/)[0]);
            updateProductPrice(productId, dailyPrice);
        }
    });

    // Обработка всех форм добавления в корзину
    document.querySelectorAll('form[action*="add-to-cart"]').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Показываем loading состояние
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавляем...';
            
            // Отправляем запрос
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Успешно добавлено
                    submitButton.innerHTML = '<i class="fas fa-check"></i> Добавлено!';
                    submitButton.className = submitButton.className.replace('btn-primary', 'btn-success');
                    
                    // Обновляем счетчик корзины
                    updateCartCounter();
                    
                    // Показываем уведомление
                    showNotification('Товар успешно добавлен в корзину!', 'success');
                    
                    // Возвращаем кнопку в исходное состояние
                    setTimeout(() => {
                        submitButton.innerHTML = originalText;
                        submitButton.className = submitButton.className.replace('btn-success', 'btn-primary');
                        submitButton.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Ошибка при добавлении товара');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.innerHTML = '<i class="fas fa-times"></i> Ошибка';
                submitButton.className = submitButton.className.replace('btn-primary', 'btn-danger');
                
                showNotification('Ошибка при добавлении товара', 'error');
                
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.className = submitButton.className.replace('btn-danger', 'btn-primary');
                    submitButton.disabled = false;
                }, 2000);
            });
        });
    });
});

// Обновление счетчика корзины
function updateCartCounter() {
    fetch('{% url "rental:cart_count_api" %}')
    .then(response => response.json())
    .then(data => {
        const cartCounter = document.querySelector('.cart-count');
        if (cartCounter) {
            cartCounter.textContent = data.count;
            cartCounter.style.display = data.count > 0 ? 'inline' : 'none';
        }
    })
    .catch(error => console.error('Error updating cart counter:', error));
}

// Показ уведомлений
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    if (type === 'error') {
        notification.style.borderLeftColor = '#dc3545';
    }
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-${type === 'success' ? 'success' : 'danger'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.getElementById('notifications').appendChild(notification);
    
    // Автоматически скрыть через 4 секунды
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 4000);
}

// Обновление цен при изменении полей
document.addEventListener('input', function(e) {
    if (e.target.name === 'quantity' || e.target.name === 'days') {
        const productId = e.target.id.split('-')[1];
        const productCard = e.target.closest('.card-body');
        const dailyPrice = parseFloat(productCard.closest('.card').querySelector('.text-success').textContent.match(/[\d.]+/)[0]);
        updateProductPrice(productId, dailyPrice);
    }
});
</script>
{% endblock %}